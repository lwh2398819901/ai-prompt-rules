# CODE REVIEW RULES

You MUST follow these rules when reviewing code. These rules are NON-NEGOTIABLE.

---

## CORE PRINCIPLES

### Principle 1: SIMPLICITY OVER COMPLEXITY

- **Goal**: Code must be readable, understandable, maintainable
- **Execution**: Avoid over-abstraction. Keep it intuitive.
- **Test**: Can a newcomer understand this code's intent within 10 minutes?
  - YES → Pass
  - NO → Needs simplification

### Principle 2: EXTRACT ONLY AFTER 3 REPETITIONS

- **Goal**: Avoid premature optimization
- **Execution**: If repeated < 3 times → Keep inline implementation
- **Reason**: Premature abstraction is the root of all evil. Wait until truly needed.

**Decision Matrix**:
| Repetitions | Action |
|-------------|--------|
| 1-2 times | ❌ DO NOT extract |
| 3+ times | ✅ MUST extract |

### Principle 3: MODERATE ABSTRACTION

- **Goal**: Balance reuse and readability
- **Execution**: Extract common logic, but don't pursue extreme abstraction
- **Test**: Abstraction layers ≤ 3
  - If > 3 layers → Over-abstracted. Flatten it.

### Principle 4: FORMAT CONSISTENCY

- **Goal**: Unified code style across entire project
- **Execution**: Use automated tools (black/flake8/autopep8 for Python, ESLint for JS)
- **Test**: Must pass PEP 8 (Python) or ESLint (JS) checks

---

## REVIEW LEVELS

| Level | Name | Coverage | Time | When to Use |
|-------|------|----------|------|-------------|
| L1 | Quick Scan | 10-20% | 5-10 min | Daily commits |
| L2 | Focused Review | 40-60% | 30-60 min | Feature completion |
| L3 | Full Review | 100% | 2-4 hours | Major refactor / Pre-release |

---

### L1 - QUICK SCAN

**When**: Daily commits

**Checklist** - ALL must pass:
- [ ] Code runs without errors
- [ ] No syntax errors
- [ ] No obvious duplicate code
- [ ] Import statements cleaned up
- [ ] Correct blank lines and indentation

**Tools**: Use project's linter for basic syntax check

**Pass Criteria**:
- ✅ No syntax errors
- ✅ No obvious format issues
- ✅ Passes basic linter check

---

### L2 - FOCUSED REVIEW

**When**: Feature completion

**Checklist** - ALL must pass:
- [ ] Passes complete format check
- [ ] Duplicate code extracted (if ≥ 3 times)
- [ ] Function length < 100 lines
- [ ] Cyclomatic complexity < 10
- [ ] Clear variable naming
- [ ] Critical logic has comments
- [ ] No hardcoded configurations
- [ ] Complete error handling

**Tools**: Linter + complexity analysis tools

**Pass Criteria**:
- ✅ L1 all passed
- ✅ No code repeated 3+ times
- ✅ All functions < 100 lines
- ✅ Cyclomatic complexity < 10

---

### L3 - FULL REVIEW

**When**: Major refactor / Pre-release

**Checklist** - ALL must pass:
- [ ] All files pass format check
- [ ] No code repeated 3+ times
- [ ] Complexity < 10 for all functions
- [ ] Architecture reasonableness verified
- [ ] Performance issues identified
- [ ] Security scan completed
- [ ] All TODOs resolved
- [ ] Documentation updated

**Execution**:
1. Run tools to scan ALL code
2. Manually review critical modules
3. Generate review report

**Pass Criteria**:
- ✅ L2 all passed
- ✅ 100% format compliance
- ✅ Duplicate code rate < 3%
- ✅ Architecture is sound
- ✅ Documentation complete

---

## ISSUE SEVERITY HANDLING

```
Issue Found
    ↓
Severity Level?
    ├─ FATAL (syntax error) → Fix IMMEDIATELY. Block commit.
    ├─ SEVERE (>5 repetitions) → Fix TODAY
    ├─ MODERATE (3 repetitions) → Fix THIS WEEK
    └─ MINOR (optimization suggestion) → Record TODO. Prioritize later.
```

---

## DUPLICATE CODE RULES

### WHEN TO EXTRACT

| Repetitions | Lines | Action | Reason |
|-------------|-------|--------|--------|
| 1-2 | Any | ❌ DO NOT extract | May be coincidental |
| 3 | < 5 | ⚠️ Consider extracting | Weigh extraction cost |
| 3 | 5-20 | ✅ MUST extract | Clear duplication pattern |
| 3 | > 20 | ✅ MUST extract | Major duplication |
| 4+ | Any | ✅ MUST extract | Regardless of line count |

### WHEN NOT TO EXTRACT (Even if "Duplicated")

| Scenario | Reason | Example |
|----------|--------|---------|
| CRUD layer standard operations | Each has different business semantics | get/create/update/delete |
| Initialization code | One-time execution, won't change | Database init scripts |
| Test cases | Independence > reuse | Unit tests |
| Config files | Similar structure, different semantics | Environment configs |
| Base utility functions | Already minimal granularity | Basic get/set |

### DECISION TREE

```
Found Duplicate Code
    ↓
How many times repeated?
    ├─ 1-2 times → ❌ DO NOT extract. Keep inline.
    ├─ 3 times → Continue evaluation:
    │   ├─ < 5 lines → Weigh: extraction cost vs maintenance cost
    │   │   ├─ Simple logic → ⚠️ Optional extraction
    │   │   └─ Complex logic → ✅ Extract
    │   └─ ≥ 5 lines → ✅ MUST extract
    └─ 4+ times → ✅ MUST extract. No exceptions.

After Extraction, Verify:
    ├─ Did readability decrease? → YES → Rollback
    ├─ Did complexity increase? → YES → Rollback
    └─ Did maintenance cost actually decrease? → NO → Rollback
```

---

## ANTI-PATTERN DETECTION

You MUST identify and flag these anti-patterns:

| Anti-Pattern | Description | Consequence | Correct Approach |
|--------------|-------------|-------------|------------------|
| Premature Abstraction | Extract before 3 repetitions | Increased complexity | Wait for 3 repetitions |
| Over-Abstraction | > 3 abstraction layers | Hard to understand | Keep flat |
| God Class | Single file > 2000 lines | Hard to maintain | Split into modules |
| Magic Numbers | Hardcoded constants | Hard to modify | Use named constants |
| Long Function | > 100 lines | Hard to understand | Split function |
| Deep Nesting | > 4 levels nested | Hard to understand | Early return pattern |

**Detection Methods**:
- Use complexity analysis tools for long/complex functions
- Use file statistics tools for large files
- Use IDE built-in code analysis features

---

## SUMMARY TABLE

| Dimension | Requirement |
|-----------|-------------|
| Duplication | Extract only after 3+ times |
| Abstraction | Moderate > Extreme |
| Readability | Simple > Complex |
| Formatting | Automated tools > Manual checking |
| Coverage | L3 full review = 100% files |
| Standard | Project-defined code conventions |
| Maintenance | Continuous improvement > One-time perfection |

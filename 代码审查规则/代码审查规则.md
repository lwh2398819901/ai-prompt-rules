# 🔍 代码审查规则体系

## 🎯 核心原则

### 原则 1：简洁优于复杂
- **目标**：代码易读、易懂、易维护
- **执行**：避免过度抽象，保持直观性
- **检验**：新人能否在10分钟内理解这段代码的意图

### 原则 2：重复3次才提取
- **目标**：避免过度优化
- **执行**：重复少于3次，保持原地实现
- **理由**：提前抽象是万恶之源，等到真正需要时再重构

### 原则 3：适度抽象
- **目标**：平衡复用和可读性
- **执行**：提取公共逻辑，但不追求极致抽象
- **检验**：抽象层次不超过3层

### 原则 4：格式一致性
- **目标**：全项目统一的代码风格
- **执行**：使用自动化工具（black/flake8/autopep8）
- **检验**：通过 PEP 8 检查（Python）或 ESLint（JS）

---

## 📋 代码审查分级

### 审查级别定义

| 级别 | 名称 | 覆盖率 | 耗时 | 何时使用 |
|-----|------|-------|------|---------|
| L1 | 快速扫描 | 10-20% | 5-10分钟 | 日常提交 |
| L2 | 重点审查 | 40-60% | 30-60分钟 | 功能完成 |
| L3 | 全面审查 | 100% | 2-4小时 | 重大重构/发版前 |

### L1 - 快速扫描

**检查内容**：
- 语法错误
- 明显的重复代码
- 导入未使用
- 空行和缩进问题

**工具**：
```bash
# Python
flake8 --select=F,E1,E2,W1,W2 modified_files.py

# JavaScript
eslint --fix modified_files.js
```

### L2 - 重点审查

**检查内容**：
- 重复模式（>=3次）
- 函数长度（>50行需拆分）
- 代码复杂度（圈复杂度>10）
- 命名规范
- 注释完整性

**工具**：
```bash
# Python
pylint --disable=C,R modified_files.py
radon cc modified_files.py -a

# JavaScript
eslint --fix src/
```

### L3 - 全面审查

**检查内容**：
- 所有文件的重复模式
- 架构合理性
- 性能隐患
- 安全问题
- 文档完整性

**执行方式**：
- 使用工具扫描全部代码
- 手动审查关键模块
- 生成审查报告

---

## 🔧 重复代码识别规则

### 何时提取公共代码

| 重复次数 | 行数 | 操作 | 理由 |
|---------|------|------|------|
| 1-2次 | 任意 | ❌ 不提取 | 可能是偶然重复 |
| 3次 | <5行 | ⚠️ 考虑提取 | 权衡提取成本 |
| 3次 | 5-20行 | ✅ 必须提取 | 明确的重复模式 |
| 3次 | >20行 | ✅ 必须提取 | 重大重复 |
| 4次+ | 任意 | ✅ 必须提取 | 无论多少行 |

### 不应该提取的"重复"

| 场景 | 原因 | 示例 |
|-----|------|------|
| CRUD层的标准操作 | 每个操作有不同的业务语义 | get/create/update/delete |
| 初始化代码 | 一次性执行，不会修改 | 数据库初始化脚本 |
| 测试用例 | 独立性比复用更重要 | 单元测试 |
| 配置文件 | 结构相似但语义不同 | 不同环境的配置 |
| 底层工具函数 | 已经是最小粒度 | 基础的get/set |

### 重复检测方法

**前端（JavaScript/Vue）**：
```bash
# 查找重复的函数定义
grep -r "const formatTime\|function formatTime" src/

# 统计重复次数
grep -r "formatTime" src/ | wc -l
```

**后端（Python）**：
```bash
# 查找重复的查询模式
grep -r "db\.query(.*).filter" app/ --include="*.py" -c

# 查找未使用的导入
flake8 --select=F401 app/
```

---

## 📏 代码质量标准

### 函数/方法长度限制

| 语言 | 建议行数 | 最大行数 | 超出时 |
|-----|---------|---------|--------|
| Python | 30-50行 | 100行 | 拆分函数 |
| JavaScript | 20-40行 | 80行 | 拆分函数 |
| Vue组件 | 200-500行 | 2000行 | 拆分子组件 |

### 复杂度限制

| 指标 | 阈值 | 检测工具 |
|-----|------|---------|
| 圈复杂度 | <10 | radon/complexity-report |
| 嵌套层级 | <4 | 人工检查 |
| 参数个数 | <5 | 人工检查 |
| 类/模块行数 | <500 | wc -l |

### 命名规范

**Python**：
```
类名：PascalCase          ✅ UserService
函数名：snake_case        ✅ get_user_by_id
常量：UPPER_SNAKE_CASE   ✅ MAX_RETRY_COUNT
变量：snake_case          ✅ user_name
私有：_leading_underscore ✅ _internal_method
```

**JavaScript/Vue**：
```
类名/组件：PascalCase     ✅ UserService, AccountList
函数名：camelCase         ✅ getUserById
常量：UPPER_SNAKE_CASE   ✅ MAX_RETRY_COUNT
变量：camelCase           ✅ userName
```

---

## 🎨 代码格式规范

### Python格式检查

**必须通过的检查**：
```bash
# 1. 基础语法和格式
flake8 --max-line-length=120 --extend-ignore=E501,W503 app/

# 2. 导入排序
isort --check-only app/

# 3. 代码格式化（检查模式）
black --check app/
```

**允许忽略的警告**：
| 错误码 | 含义 | 忽略原因 |
|-------|------|---------|
| E501 | 行过长 | 有时为了可读性 |
| W503 | 运算符前换行 | 与black冲突 |
| E402 | 模块导入不在顶部 | 条件导入场景 |
| E722 | bare except | 特定场景需要 |
| F541 | f-string无占位符 | 有时为了格式一致 |

**自动修复命令**：
```bash
# 修复空格和缩进
autopep8 --in-place --aggressive --recursive app/

# 清理未使用的导入
autoflake --in-place --remove-all-unused-imports --recursive app/

# 格式化代码
black app/

# 排序导入
isort app/
```

### JavaScript/Vue格式检查

**必须通过的检查**：
```bash
# ESLint检查
eslint src/ --max-warnings 0

# Prettier检查
prettier --check "src/**/*.{js,vue}"
```

**自动修复**：
```bash
eslint --fix src/
prettier --write "src/**/*.{js,vue}"
```

---

## 🔍 审查检查清单

### 提交前检查（L1级别）

- [ ] 代码能正常运行
- [ ] 通过语法检查（flake8/eslint）
- [ ] 无明显重复代码
- [ ] 导入语句已清理
- [ ] 空行和缩进正确

### 功能完成检查（L2级别）

- [ ] 通过完整的格式检查
- [ ] 重复代码已提取（3次以上）
- [ ] 函数长度合理（<100行）
- [ ] 变量命名清晰
- [ ] 关键逻辑有注释
- [ ] 无硬编码配置
- [ ] 错误处理完整

### 发版前检查（L3级别）

- [ ] 全部文件格式检查通过
- [ ] 无重复3次以上的代码
- [ ] 代码复杂度合格（<10）
- [ ] 所有TODO已处理
- [ ] 文档已更新
- [ ] 性能测试通过
- [ ] 安全扫描通过

---

## 📊 重复代码提取决策树

```
发现重复代码
  ↓
重复几次？
  ├─ 1-2次 → ❌ 不提取，保持原地实现
  ├─ 3次 → 继续判断
  │   ├─ <5行 → 权衡：提取成本 vs 维护成本
  │   │   ├─ 简单逻辑 → ⚠️ 可选提取
  │   │   └─ 复杂逻辑 → ✅ 提取
  │   └─ ≥5行 → ✅ 必须提取
  └─ 4次+ → ✅ 必须提取，无论行数

提取后检查：
  ├─ 是否降低了可读性？ → 是 → 回滚
  ├─ 是否增加了复杂度？ → 是 → 回滚
  └─ 是否真正减少维护成本？ → 否 → 回滚
```

---

## 🎯 实际审查案例

### 案例1：formatTime函数

**发现**：7个组件中重复定义
```javascript
// Account.vue, LogView.vue, Dashboard.vue... (7处)
const formatTime = (time) => {
  if (!time) return '-'
  const date = new Date(time)
  return date.toLocaleString('zh-CN')
}
```

**决策**：✅ 提取
- 重复次数：7次（>>3）
- 行数：5行
- 逻辑：完全一致

**行动**：
```javascript
// src/utils/format.js
export function formatTime(time) {
  if (!time) return '-'
  const date = new Date(time)
  return date.toLocaleString('zh-CN')
}

// 各组件
import { formatTime } from '@/utils/format'
```

**结果**：删除35行重复代码（7×5）

---

### 案例2：CRUD层的查询

**发现**：38次 db.query 在 crud/agency.py
```python
def get(self, db, id): 
    return db.query(Agency).filter(Agency.id == id).first()

def get_by_name(self, db, name):
    return db.query(Agency).filter(Agency.name == name).first()
```

**决策**：❌ 不提取
- 重复次数：38次（虽然多）
- 场景：CRUD层标准操作
- 原因：每个方法有不同的业务语义和过滤条件

**理由**：
- CRUD层本身就是数据访问的抽象层
- 每个查询有不同的过滤条件
- 强行提取会降低可读性

---

### 案例3：OAuthApp查询

**发现**：8处重复的查询+错误处理
```python
# 8个service文件中
oauth_app = db.query(OAuthApp).filter(OAuthApp.id == id).first()
if not oauth_app:
    raise ExternalApiCallError("OAuth应用不存在")
```

**决策**：✅ 提取
- 重复次数：8次（>>3）
- 行数：3行
- 逻辑：完全一致

**行动**：
```python
# utils/db_helpers.py
def get_oauth_app_by_id(db, oauth_app_id, error_message="OAuth应用不存在"):
    oauth_app = db.query(OAuthApp).filter(OAuthApp.id == oauth_app_id).first()
    if not oauth_app:
        raise HTTPException(status_code=404, detail=error_message)
    return oauth_app

# 各service
from app.utils.db_helpers import get_oauth_app_by_id
oauth_app = get_oauth_app_by_id(db, oauth_app_id)
```

**结果**：删除21行重复代码（8×3-3）

---

## 🚫 反模式识别

### 常见反模式

| 反模式 | 描述 | 后果 | 正确做法 |
|-------|------|------|---------|
| 过早抽象 | 重复<3次就提取 | 增加复杂度 | 等到3次再提取 |
| 过度抽象 | 抽象层次>3层 | 难以理解 | 保持扁平 |
| 上帝类 | 单文件>2000行 | 难以维护 | 拆分模块 |
| 魔法数字 | 硬编码常量 | 难以修改 | 使用常量 |
| 长函数 | >100行 | 难以理解 | 拆分函数 |
| 深嵌套 | 嵌套>4层 | 难以理解 | 提前返回 |

### 识别方法

```bash
# 查找长函数（Python）
radon cc app/ -s -a | grep "^    M"

# 查找复杂函数
radon cc app/ -a -nc | grep -E "C \([0-9]{2,}\)"

# 查找大文件
find app/ -name "*.py" -exec wc -l {} + | sort -nr | head -10
```

---

## 📈 代码质量指标

### 目标指标

| 指标 | 目标值 | 计算方法 |
|-----|--------|---------|
| 重复代码率 | <3% | 重复行数/总行数 |
| 平均函数长度 | <30行 | 总行数/函数数 |
| 平均圈复杂度 | <5 | 总复杂度/函数数 |
| 文档覆盖率 | >80% | 有文档的函数/总函数 |
| 测试覆盖率 | >70% | 覆盖代码行/总代码行 |

### 测量工具

```bash
# Python代码质量
radon cc app/ -a -s          # 圈复杂度
radon mi app/ -s             # 可维护性指数
pylint app/ --reports=y      # 综合质量报告

# JavaScript代码质量
eslint src/ --format=json    # ESLint报告
npm run test:coverage        # 测试覆盖率
```

---

## ✅ 审查结果判定

### 通过标准

**L1快速扫描通过**：
- ✅ 无语法错误
- ✅ 无明显格式问题
- ✅ 通过基础flake8检查

**L2重点审查通过**：
- ✅ L1全部通过
- ✅ 无3次以上重复代码
- ✅ 函数长度<100行
- ✅ 圈复杂度<10

**L3全面审查通过**：
- ✅ L2全部通过
- ✅ 代码格式100%符合PEP 8
- ✅ 重复代码率<3%
- ✅ 架构合理
- ✅ 文档完整

---

## 🔄 持续改进

### 定期审查频率

| 时机 | 级别 | 频率 |
|-----|------|------|
| 每次提交 | L1 | 每天 |
| 功能完成 | L2 | 每周 |
| 发版前 | L3 | 每月 |
| 重大重构 | L3 | 按需 |

### 审查结果处理

```
发现问题
  ↓
严重程度？
  ├─ 致命（语法错误） → 立即修复，阻止提交
  ├─ 严重（重复>5次） → 当天修复
  ├─ 一般（重复3次） → 本周修复
  └─ 轻微（建议优化） → 记录TODO，按优先级处理
```

---

## 核心原则总结

| 维度 | 要求 |
|-----|------|
| **重复** | 3次以上才提取 |
| **抽象** | 适度 > 极致 |
| **可读性** | 简洁 > 复杂 |
| **格式** | 工具自动化 > 人工检查 |
| **覆盖** | L3全面审查 = 100%文件 |
| **标准** | PEP 8 / ESLint |
| **维护** | 持续改进 > 一次完美 |

